# DST Agent Brain 重构计划

## 重构目标
将现有的单体架构重构为模块化、可扩展的架构，提升代码的可维护性、可测试性和可扩展性。

## 关键改动点

### 1. 项目结构重组
- [x] 创建新的目录结构
- [x] 分离配置管理
- [x] 模块化API路由
- [x] 服务层抽象
- [x] 数据模型定义

### 2. 配置管理重构
- [x] 移除硬编码的API密钥
- [x] 使用环境变量管理敏感配置
- [x] 创建统一的配置管理类

### 3. 状态管理重构
- [x] 移除全局变量
- [x] 实现线程安全的状态管理器
- [x] 支持多代理状态管理

### 4. 依赖注入实现
- [x] 服务层依赖注入
- [x] 路由层依赖注入
- [x] 配置依赖注入

### 5. 错误处理统一化
- [x] 自定义异常类
- [x] 统一的异常处理机制
- [x] 错误日志记录

### 6. 模型定义
- [x] 动作模型
- [x] 感知数据模型
- [x] 事件模型
- [x] 响应模型

## 重构步骤

### 第一阶段：基础结构搭建
1. 创建新的目录结构
2. 配置管理模块
3. 基础模型定义

### 第二阶段：核心服务迁移
1. 队列服务迁移
2. LLM服务抽象
3. 工具执行器重构

### 第三阶段：API层重构
1. 路由模块化
2. 依赖注入实现
3. 异常处理统一

### 第四阶段：状态管理重构
1. 状态管理器实现
2. 多代理支持
3. 线程安全保证

## 文件迁移映射

| 原文件 | 新位置 | 状态 |
|--------|--------|------|
| server.py | src/main.py + src/api/routes/ | 待迁移 |
| task.py | src/services/llm_service.py | 待迁移 |
| tool_executor.py | src/services/tool_service.py | 待迁移 |
| utils.py | src/services/queue_service.py | 待迁移 |
| parse_tool.py | src/utils/parsers.py | 待迁移 |
| prompt.py | src/core/prompts.py | 待迁移 |
| recipes/ | src/data/recipes/ | 待迁移 |
| memory/ | src/data/memory/ | 待迁移 |

## 测试计划
- [ ] 单元测试覆盖
- [ ] 集成测试
- [ ] API测试
- [ ] 性能测试

## 部署计划
- [ ] 环境变量配置
- [ ] Docker化
- [ ] 部署脚本
- [ ] 监控配置 